<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>A101 Stok Sorgulama</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; background:#f2f2f2; padding:20px }
.box { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:8px }
input, button { width:100%; padding:10px; margin-top:10px; font-size:16px }
button:disabled { background:#ccc }
table { width:100%; border-collapse:collapse; margin-top:20px }
th, td { border:1px solid #ccc; padding:8px }
th { background:#eee }
.sufficient { color:green; font-weight:bold }
.limited { color:orange; font-weight:bold }
.out { color:red; font-weight:bold }
.info { margin-top:10px; font-style:italic }
</style>
</head>
<body>

<div class="box">
<h2>A101 En Yakın Mağaza Stok Sorgu</h2>

<label>Ürün (Item ID)</label>
<input id="itemId" value="30000905">

<button id="btn" onclick="sorgula()">Sorgula</button>

<div id="info" class="info"></div>
<div id="tablo"></div>
</div>

<script>
const GEOHASH = "sxkc1x5gj";
let kilitli = false;

/* ---------------- SORGU ---------------- */
async function sorgula() {
    if (kilitli) return;
    kilitli = true;

    const btn = document.getElementById("btn");
    const info = document.getElementById("info");
    const tabloDiv = document.getElementById("tablo");

    btn.disabled = true;
    let kalan = 20;
    btn.textContent = `Bekleyin (${kalan})`;

    const sayac = setInterval(() => {
        kalan--;
        btn.textContent = `Bekleyin (${kalan})`;
        if (kalan <= 0) {
            clearInterval(sayac);
            kilitli = false;
            btn.disabled = false;
            btn.textContent = "Sorgula";
        }
    }, 1000);

    info.textContent = "Sorgulanıyor...";
    tabloDiv.innerHTML = "";

    const payload = {
        geoHash: GEOHASH,
        itemId: document.getElementById("itemId").value.trim()
    };

    const url =
        "https://rio.a101.com.tr/dbmk89vnr/CALL/StoreContentManager/nearestStores/default" +
        "?__culture=tr-TR&__platform=web&data=" +
        btoa(JSON.stringify(payload)) +
        "&__isbase64=true";

    try {
        const response = await fetch(url);
        const json = await response.json();

        // Mesafeye göre sırala
        const stores = (json.stores || []).sort(
            (a, b) => a.distance - b.distance
        );

        info.textContent = `Toplam ${stores.length} mağaza bulundu`;
        tabloOlustur(stores);

    } catch (e) {
        info.textContent = "❌ Sorgu sırasında hata oluştu";
    }
}

/* ---------------- TABLO ---------------- */
function tabloOlustur(stores) {
    if (!stores.length) {
        document.getElementById("tablo").textContent = "Mağaza bulunamadı";
        return;
    }

    let html = `
    <table>
        <thead>
            <tr>
                <th>Mesafe (m)</th>
                <th>Kod</th>
                <th>Mağaza</th>
                <th>İl</th>
                <th>İlçe</th>
                <th>Adres</th>
                <th>Stok</th>
            </tr>
        </thead>
        <tbody>
    `;

    stores.forEach(s => {
        let cls = "out";
        let txt = s.stockLevel;

        if (s.stockLevel === "sufficient") {
            cls = "sufficient";
            txt = "Yeterli";
        } else if (s.stockLevel === "limited") {
            cls = "limited";
            txt = "Sınırlı";
        }

        html += `
        <tr>
            <td>${s.distance}</td>
            <td>${s.id}</td>
            <td>${s.name}</td>
            <td>${s.city}</td>
            <td>${s.townShip}</td>
            <td>${s.address}</td>
            <td class="${cls}">${txt}</td>
        </tr>
        `;
    });

    html += "</tbody></table>";
    document.getElementById("tablo").innerHTML = html;
}
</script>

</body>
</html>